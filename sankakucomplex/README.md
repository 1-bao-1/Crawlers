## SankakuComplex图片下载器

* 输入tag即可下载图片，默认保存文件夹名为tag名
* 使用aio，可自行设置并发量
* ~~然而在不科学上网的情况下还是很慢~~

### 2020年1月20日更新

1. 修复队列可能阻塞的bug；当抛出异常时无法完成相应的`task_done`操作，因此会导致阻塞。
2. 将默认超时时间调整为45s，如果超时则停止下载。

关于超时，aiohttp官方文档的描述：

> By default *aiohttp* uses a *total* 5min timeout, **it means that the whole operation should finish in 5 minutes.**

也就是说，如果发生超时可能会导致图片没有完全下载的情况，然而考虑到大部分图片都能在45s内下载完毕，所以还是将超时设为45s了。

#### 补充更新

当获取到空数据列表时，应该取出队列中所有剩余数据以清空生产者队列，同时要捕获可能发生的异常。当队列取消堵塞后调用`task.cancel()`协程会抛出一个`asyncio.CancelledError`以取消协程，在`finally`代码块中不应该直接使用`queue.task_done()`，而是要判断数据列表是否为空，若不为空则调用`task_done()`方法，否则会抛出调用`task_done()`次数过多的异常，具体原因应该是当数据列表为空时会进入while循环首先调用一遍`task_done()`，而最后取消阻塞则会引发异常，此时已经调用了`task_done()`，无需重复调用。

### 心得

aio算是新技术，虽然也出来很久了，但是目前看到的电子书上都没有相关的介绍，官方文档如果能耐得下心去看的话其实还是有很大帮助的，不要以为浮躁而错失了一项新技术。性能上aio比多线程要好，用法上个人感觉也比多线程容易，不过想要发挥aio的全部威力还是得借助`asyncio.Queue()`的生产者消费者模型。此外分析页面也是爬虫必不可少的一步，解析静态网页很容易，如果是动态加载的页面就可能会涉及到ajax、js等技术，还是得活到老学到老。